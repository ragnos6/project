- name: Deploy djangooo over SSH
  uses: appleboy/ssh-action@v1.0.0
  with:
    host: ${{ secrets.VPS_HOST }}
    username: ${{ secrets.VPS_USER }}
    key: ${{ secrets.VPS_SSH_KEY }}
    script: |
      set -e
      echo "=== Начало деплоя ==="
      
      # Установка Docker (если не установлен)
      if ! command -v docker &> /dev/null; then
        echo "[*] Установка Docker..."
        sudo apt update -y
        sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release
        curl -fsSL https://get.docker.com | sudo sh
        sudo usermod -aG docker $USER
        # Применяем изменения группы без перезагрузки
        newgrp docker <<EONG || true
EONG
      fi

      # Установка Docker Compose (отдельный бинарник для совместимости)
      if ! command -v docker-compose &> /dev/null; then
        echo "[*] Установка Docker Compose..."
        sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose
      fi

      # Проверка версий
      docker --version
      docker-compose --version

      cd ~/project
      echo "[*] Работа с томами БД..."
      
      # Восстановление тома (совместимый метод)
      if [ ! -d "/var/lib/docker/volumes/project_db/_data" ]; then
        if [ -f "project_db.tar.gz" ]; then
          echo "→ Восстановление тома из архива"
          sudo mkdir -p /var/lib/docker/volumes/project_db/_data
          sudo tar -xzvf project_db.tar.gz -C /var/lib/docker/volumes/project_db/_data
        else
          echo "→ Создание нового тома"
          sudo mkdir -p /var/lib/docker/volumes/project_db/_data
        fi
      fi

      echo "[*] Перезапуск контейнеров..."
      # Используем docker-compose вместо docker compose
      docker-compose down || true
      docker-compose up -d --build

      echo "[*] Ожидание запуска БД..."
      # Универсальный метод проверки через логи
      for i in {1..30}; do
        if sudo docker logs $(sudo docker ps -qf "name=db") 2>&1 | grep -q "ready to accept connections"; then
          echo "→ БД запущена успешно!"
          break
        fi
        echo "→ Ожидание БД ($i/30)..."
        sleep 5
        if [ $i -eq 30 ]; then
          echo "[!] Ошибка: БД не запустилась"
          sudo docker logs $(sudo docker ps -qf "name=db")
          exit 1
        fi
      done

      echo "[*] Применение миграций..."
      # Используем docker-compose exec
      docker-compose exec -T project_cars python manage.py makemigrations
      docker-compose exec -T project_cars python manage.py migrate

      echo "[*] Сбор статики..."
      docker-compose exec -T project_cars python manage.py collectstatic --noinput --clear

      echo "[*] Очистка..."
      docker system prune -f --filter "until=72h"

      echo "=== Деплой успешно завершен ==="
