name: Deploy django to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Добавляем таймаут для защиты от зависаний

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Upload project to VPS
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "."
        target: "~/project"
        strip_components: 1
        overwrite: true  # Гарантированная перезапись файлов

    - name: Deploy over SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          echo "=== Начало деплоя ==="
          
          # Оптимизация: проверка Docker только при необходимости
          if ! command -v docker &> /dev/null; then
            echo "[*] Установка Docker..."
            sudo apt update -y
            sudo apt install -y apt-transport-https ca-certificates curl software-properties-common
            
            # Официальный метод установки Docker
            curl -fsSL https://get.docker.com | sudo sh
            
            # Настройка прав
            sudo usermod -aG docker $USER
            sudo mkdir -p /etc/docker
            echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/docker" | sudo tee /etc/sudoers.d/docker
          fi

          # Обновление только при необходимости
          docker_version=$(docker compose version 2>/dev/null | grep -oP 'v?\K\d+\.\d+\.\d+')
          if [[ $docker_version < "2.22.0" ]]; then
            echo "[*] Обновление Docker Compose..."
            sudo apt update -y
            sudo apt install --only-upgrade docker-compose-plugin -y
          fi

          cd ~/project
          echo "[*] Работа с томами БД..."
          
          # Улучшенное восстановление тома
          if ! docker volume inspect project_db &>/dev/null; then
            if [[ -f project_db.tar.gz ]]; then
              echo "→ Восстановление тома из архива"
              docker volume create project_db
              docker run --rm -v project_db:/target -v $PWD:/backup alpine \
                tar xzf /backup/project_db.tar.gz -C /target
            else
              echo "→ Создание нового тома"
              docker volume create project_db
            fi
          fi

          echo "[*] Перезапуск контейнеров..."
          docker compose down --remove-orphans --timeout 30 || true
          docker compose up -d --build --pull always  # Автообновление образов

          # Умное ожидание БД вместо sleep
          echo "[*] Ожидание запуска БД..."
          if ! docker compose exec db pg_isready -U postgres -d your_db_name -t 30; then
            echo "[!] Ошибка: БД не запустилась"
            docker compose logs db
            exit 1
          fi

          echo "[*] Применение миграций..."
          docker compose exec -T project_cars python manage.py makemigrations
          docker compose exec -T project_cars python manage.py migrate

          echo "[*] Сбор статики..."
          docker compose exec -T project_cars python manage.py collectstatic --noinput --clear

          echo "[*] Очистка..."
          docker system prune -f --filter "until=72h"

          echo "=== Деплой успешно завершен ==="
