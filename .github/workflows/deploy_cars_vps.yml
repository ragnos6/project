name: Deploy Cars Project to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Upload project to VPS
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "."
        target: "~/project"
        strip_components: 1
        overwrite: true

    - name: Create .env on VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          echo "${{ secrets.ENV_FILE }}" > ~/project/.env
          chmod 600 ~/project/.env

    - name: Deploy over SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -e
          echo "=== Начало деплоя ==="
          
          echo "[*] Установка Docker и Docker Compose при необходимости..."
          
          # Установка Docker, если не установлен
          if ! command -v docker &> /dev/null; then
            echo "→ Установка Docker..."
            sudo apt update -y
            sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release
            curl -fsSL https://get.docker.com | sudo sh
            sudo usermod -aG docker $USER || true
          fi
          
          if ! docker compose version &> /dev/null; then
            echo "→ Установка Docker Compose (CLI плагин)..."
            DOCKER_CONFIG=${DOCKER_CONFIG:-$HOME/.docker}
            mkdir -p $DOCKER_CONFIG/cli-plugins
          
            COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          
            sudo curl -L "https://github.com/docker/compose/releases/download/$COMPOSE_VERSION/docker-compose-$(uname -s)-$(uname -m)" \
              -o $DOCKER_CONFIG/cli-plugins/docker-compose
          
            sudo chmod +x $DOCKER_CONFIG/cli-plugins/docker-compose
          fi

          cd ~/project
    
          echo "[*] Обновление docker-compose.yml для использования готового образа..."
          sudo sed -i 's|build: \.|image: hunter6868/project_cars:0.3|g' docker-compose.yml
    
          echo "[*] Остановка и удаление старых контейнеров..."
          sudo docker compose down --rmi all --remove-orphans || true
    
          echo "[*] Скачивание нового образа из Docker Hub..."
          echo "${{ secrets.DOCKERHUB_PASSWORD }}" | sudo docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          sudo docker compose pull
          # явно задаём платформу для docker (если ваши образы arm64, принудить amd64)
          export DOCKER_DEFAULT_PLATFORM=linux/amd64
          
          echo "[*] Запуск контейнеров в фоновом режиме..."
          sudo docker compose up -d --build
          
          # Ожидание готовности базы данных (максимум 2 минуты)
          echo "[*] Ожидание готовности базы данных (максимум 2 минуты)..."
          for i in {1..24}; do
            if sudo docker compose exec -T db pg_isready -U postgres >/dev/null 2>&1; then
              echo "→ БД готова к подключению!"
              break
            fi
            echo "→ Ожидание БД... (попытка $i/24)"
            sleep 5
            if [ $i -eq 24 ]; then
              echo "[!] Ошибка: БД не запустилась вовремя"
              sudo docker compose logs db --tail=200
              exit 1
            fi
          done
          
          # проверяем, действительно ли внутри контейнера есть сокет и psql
          sudo docker compose exec -T db sh -c 'echo "whoami: $(whoami)"; psql -V; ls -la /var/run/postgresql || true'
          
          echo "[*] Проверка наличия дампа для восстановления..."
          if [ -f ~/project/backups/dump_1.sql ]; then
            echo "→ Найден дамп БД. Восстанавливаем..."
            # отключаем web чтобы не было активных соединений от приложения
            sudo docker compose stop web || true
          
            echo "→ Попытка завершить активные подключения к базе projectdb..."
            sudo docker compose exec -T db psql -U postgres -d postgres -c \
              "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = 'projectdb' AND pid <> pg_backend_pid();" || {
              echo "[!] Предупреждение: не удалось завершить некоторые подключения (продолжаем попытку восстановления)"
            }
          
            echo "→ Удаляем базу projectdb (если есть) и создаём заново..."
            sudo docker compose exec -T db psql -U postgres -d postgres -c "DROP DATABASE IF EXISTS projectdb;" || { echo "[!] Не удалось дропнуть DB"; sudo docker compose logs db --tail=200; exit 1; }
            sudo docker compose exec -T db psql -U postgres -d postgres -c "CREATE DATABASE projectdb OWNER hunter;" || { echo "[!] Не удалось создать DB"; sudo docker compose logs db --tail=200; exit 1; }
          
            echo "→ Восстанавливаем дамп в projectdb..."
            # Подаём дамп через stdin в psql внутри контейнера
            cat ~/project/backups/dump_1.sql | sudo docker compose exec -T db psql -U postgres -d projectdb || {
              echo "[!] Ошибка при восстановлении дампа"; sudo docker compose logs db --tail=200; exit 1;
            }
          
            echo "✓ База данных успешно восстановлена из дампа"
          else
            echo "→ Дамп не найден. Пропускаем восстановление."
          fi
          
          # Запускаем web и ждём пока он поднимется (можете ждать healthcheck/проверку эндпойнта)
          sudo docker compose up -d web
          
          # Подождём, пока web станет доступен (необязательно, но полезно)
          for i in {1..12}; do
            if sudo docker compose exec -T web python -V >/dev/null 2>&1; then
              echo "→ Web-контейнер запущен"
              break
            fi
            echo "→ Ожидание web... (попытка $i/12)"
            sleep 5
            if [ $i -eq 12 ]; then
              echo "[!] Web не поднялся вовремя"; sudo docker compose logs web --tail=200; exit 1;
            fi
          done
          
          echo "[*] Применение миграций Django..."
          sudo docker compose exec web python manage.py migrate --noinput
          
          echo "[*] Сборка статики Django..."
          sudo docker compose exec web python manage.py collectstatic --noinput --clear
          
          echo "=== Деплой завершён успешно ==="
          
