name: Deploy Cars Project to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Upload project to VPS
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "."
        target: "~/project"
        strip_components: 1
        overwrite: true

    - name: Create .env on VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          echo "${{ secrets.ENV_FILE }}" > ~/project/.env
          chmod 600 ~/project/.env

    - name: Deploy over SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -e
          echo "=== Начало деплоя ==="
          
          echo "[*] Установка Docker и Docker Compose при необходимости..."
          
          # Установка Docker, если не установлен
          if ! command -v docker &> /dev/null; then
            echo "→ Установка Docker..."
            sudo apt update -y
            sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release
            curl -fsSL https://get.docker.com | sudo sh
            sudo usermod -aG docker $USER || true
          fi
          
          # Проверка и установка плагина Docker Compose (рекомендуется)
          if ! docker compose version &> /dev/null; then
            echo "→ Установка Docker Compose (CLI плагин)..."
            DOCKER_CONFIG=${DOCKER_CONFIG:-$HOME/.docker}
            mkdir -p $DOCKER_CONFIG/cli-plugins
          
            COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          
            sudo curl -L "https://github.com/docker/compose/releases/download/$COMPOSE_VERSION/docker-compose-$(uname -s)-$(uname -m)" \
              -o $DOCKER_CONFIG/cli-plugins/docker-compose
          
            sudo chmod +x $DOCKER_CONFIG/cli-plugins/docker-compose
          fi

          cd ~/project
    
          echo "[*] Обновление docker-compose.yml для использования готового образа..."
          sudo sed -i 's|build: \.|image: hunter6868/project_cars:0.2|g' docker-compose.yml
    
          echo "[*] Остановка и удаление старых контейнеров..."
          sudo docker-compose down --rmi all --remove-orphans || true
    
          echo "[*] Скачивание нового образа из Docker Hub..."
          echo "${{ secrets.DOCKERHUB_PASSWORD }}" | sudo docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          sudo docker-compose pull
    
          echo "[*] Запуск контейнеров в фоновом режиме..."
          sudo docker-compose up -d
    
          # Ожидание готовности базы данных
          echo "[*] Ожидание готовности базы данных (максимум 2 минуты)..."
          for i in {1..24}; do
            if sudo docker-compose exec db pg_isready -U postgres; then
              echo "→ БД готова к подключению!"
              break
            fi
            echo "→ Ожидание БД... (попытка $i/24)"
            sleep 5
            if [ $i -eq 24 ]; then
              echo "[!] Ошибка: БД не запустилась вовремя"
              sudo docker-compose logs db
              exit 1
            fi
          done
    
          # Восстановление БД (если нужно)
          if [ -f ~/project/project_2025-05-03.dump ]; then
            echo "[*] Восстановление БД из резервной копии..."
            export PGPASSWORD=$(grep '^POSTGRES_PASSWORD=' ~/project/.env | cut -d '=' -f2-)
            DB_USER=$(grep '^POSTGRES_USER=' ~/project/.env | cut -d '=' -f2-)
            DB_NAME=$(grep '^POSTGRES_DB=' ~/project/.env | cut -d '=' -f2-)
            
            if [ -z "$DB_USER" ] || [ -z "$DB_NAME" ] || [ -z "$PGPASSWORD" ]; then
              echo "[!] Ошибка: не удалось прочитать параметры БД из .env"
              exit 1
            fi
            
            echo "→ Начало восстановления..."
            cat ~/project/project_2025-05-03.dump | sudo docker-compose exec -T db \
              pg_restore -U "$DB_USER" -d "$DB_NAME" --clean --if-exists
            echo "[√] Восстановление завершено"
          else
            echo "[*] Резервная копия не найдена, пропускаем восстановление"
          fi
    
          # Миграции и статика
          echo "[*] Применение миграций Django..."
          sudo docker-compose exec web python manage.py migrate
    
          echo "[*] Сборка статики Django..."
          sudo docker-compose exec web python manage.py collectstatic --noinput --clear
    
          # Проверка работы приложения
          echo "[*] Проверка доступности приложения..."
          if curl -sSf --retry 3 --retry-delay 10 http://localhost:8000 > /dev/null; then
            echo "[√] Приложение успешно запущено!"
          else
            echo "[!] Ошибка: приложение не отвечает"
            sudo docker-compose logs web
            exit 1
          fi
    
          echo "=== Деплой завершён успешно ==="