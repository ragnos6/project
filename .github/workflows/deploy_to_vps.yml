name: Deploy Django to VPS

on:
  push:
    branches:
      - main  # или ваша основная ветка

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy over SSH to VPS
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          # port: 22  # при необходимости укажите нестандартный порт
          script: |
            set -e
            echo "[`date +'%Y-%m-%d %H:%M:%S'`] Начало деплоя"

            # 1. Установка зависимостей для добавления репозитория Docker
            echo "[*] apt update и установка необходимых пакетов для репозитория Docker"
            sudo apt update
            sudo apt install -y ca-certificates curl gnupg lsb-release

            # 2. Добавление репозитория Docker, если ещё не добавлен
            if [ ! -f /etc/apt/keyrings/docker.gpg ]; then
              echo "[*] Добавление ключа GPG Docker"
              sudo install -m 0755 -d /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              sudo chmod a+r /etc/apt/keyrings/docker.gpg
            fi
            if [ ! -f /etc/apt/sources.list.d/docker.list ]; then
              echo "[*] Добавление репозитория Docker в sources.list"
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" \
                | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
            fi

            # 3. Установка или обновление Docker и плагина Compose
            echo "[*] apt update и проверка наличия Docker"
            sudo apt update
            if ! command -v docker &> /dev/null; then
              echo "[*] Установка Docker и плагина Compose"
              sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
              sudo usermod -aG docker $USER
              echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/docker" | sudo tee /etc/sudoers.d/docker
            else
              echo "[*] Docker уже установлен. Обновляем/устанавливаем плагин Compose"
              sudo apt install -y docker-compose-plugin
            fi

            echo "[*] Docker version: $(sudo docker --version)"
            echo "[*] Docker Compose version: $(sudo docker compose version)"

            # 4. Переход в директорию проекта или клонирование
            if [ ! -d ~/project ]; then
              echo "[*] Директория ~/project не найдена. Клонирование репозитория..."
              git clone git@github.com:your_user/your_repo.git ~/project
            fi
            cd ~/project

            # 5. Обновление кода
            echo "[*] Git fetch и reset к origin/main"
            git fetch --all
            git reset --hard origin/main

            # 6. Проверка/восстановление тома БД (если требуется файловый бэкап)
            echo "[*] Проверка тома project_db"
            if [ -z "$(sudo docker volume ls -q -f name=project_db)" ]; then
              if [ -f "project_db.tar.gz" ]; then
                echo "[*] Восстановление тома project_db из архива"
                sudo docker volume create project_db
                sudo docker run --rm \
                  -v project_db:/volume \
                  -v "$(pwd)":/backup \
                  alpine \
                  sh -c "cd /volume && tar xzf /backup/project_db.tar.gz --strip-components=1"
              else
                echo "[*] Архив project_db.tar.gz не найден. Создание пустого тома project_db"
                sudo docker volume create project_db
              fi
            else
              echo "[*] Том project_db уже существует, пропускаем восстановление"
            fi

            # 7. Перезапуск контейнеров
            echo "[*] Перезапуск контейнеров Docker Compose"
            sudo docker compose down || true
            sudo docker compose up -d --build

            # 8. Ожидание готовности БД через pg_isready
            DB_SERVICE="db"       # замените на имя сервиса БД из docker-compose.yml
            DB_USER="postgres"    # пользователь БД
            MAX_TRIES=30
            SLEEP_SEC=2

            echo "[*] Ожидание готовности БД (${DB_SERVICE})"
            for i in $(seq 1 $MAX_TRIES); do
              if sudo docker compose exec -T $DB_SERVICE pg_isready -U $DB_USER &> /dev/null; then
                echo "[*] БД готова после попытки ${i}"
                break
              fi
              echo "[*] Попытка ${i}/${MAX_TRIES}: БД ещё не готова, ждём ${SLEEP_SEC} сек..."
              sleep $SLEEP_SEC
              if [ "$i" -eq "$MAX_TRIES" ]; then
                echo "Ошибка: БД не стала готовой за ожидаемое время"
                exit 1
              fi
            done

            # 9. Применение миграций
            APP_SERVICE="project_cars"  # замените на имя вашего сервиса приложения
            echo "[*] Применение миграций"
            sudo docker compose exec -T $APP_SERVICE python manage.py migrate

            # 10. Сбор статики
            echo "[*] Сбор статики"
            sudo docker compose exec -T $APP_SERVICE python manage.py collectstatic --noinput

            # 11. (Опционально) Проверка health endpoint
            # echo "[*] Проверка health endpoint"
            # if ! sudo docker compose exec -T $APP_SERVICE curl -f http://localhost:8000/health/; then
            #   echo "Warning: health endpoint недоступен"
            # fi

            echo "[`date +'%Y-%m-%d %H:%M:%S'`] Деплой завершён успешно"
