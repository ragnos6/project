name: Deployyyy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Upload project to VPS
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "."
        target: "~/project"
        strip_components: 1
        overwrite: true

    - name: Deploy over SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -e
          echo "=== Начало деплоя ==="
          
          # Установка Docker
          if ! command -v docker &> /dev/null; then
            echo "[*] Установка Docker..."
            sudo apt update -y
            sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release
            curl -fsSL https://get.docker.com | sudo sh
            sudo usermod -aG docker $USER
          fi

          # Установка Docker Compose
          if ! command -v docker-compose &> /dev/null; then
            echo "[*] Установка Docker Compose..."
            DOCKER_COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep '"tag_name":' | cut -d'"' -f4)
            sudo curl -L "https://github.com/docker/compose/releases/download/$DOCKER_COMPOSE_VERSION/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi

          cd ~/project
          echo "[*] Работа с томом БД..."
          
          # Восстановление данных PostGIS
          if [ -f "project_db.tar.gz" ]; then
            echo "→ Восстановление данных БД из архива"
            sudo docker volume create project_db
            sudo docker run --rm \
              -v project_db:/restore \
              -v $(pwd):/backup \
              alpine \
              sh -c "rm -rf /restore/* && tar xzf /backup/project_db.tar.gz -C /restore"
          else
            echo "→ Архив БД не найден, будет использован чистый том"
          fi

          echo "[*] Перезапуск контейнеров..."
          docker-compose down || true
          docker-compose up -d --build

          echo "[*] Ожидание инициализации PostGIS (до 120 секунд)..."
          for i in {1..24}; do
            CONTAINER_STATUS=$(sudo docker inspect --format '{{.State.Health.Status}}' project_db 2>/dev/null || echo "starting")
            if [ "$CONTAINER_STATUS" = "healthy" ]; then
              echo "→ БД готова к подключению!"
              break
            fi
            echo "→ Статус БД: $CONTAINER_STATUS ($i/24)"
            sleep 5
            if [ $i -eq 24 ]; then
              echo "[!] Ошибка: БД не запустилась"
              sudo docker logs project_db || true
              exit 1
            fi
          done

          echo "[*] Применение миграций Django..."
          docker-compose exec -T web python manage.py makemigrations
          docker-compose exec -T web python manage.py migrate

          echo "[*] Сбор статики Django..."
          docker-compose exec -T web python manage.py collectstatic --noinput --clear

          echo "[*] Проверка работы приложения..."
          if curl -sSf --retry 3 --retry-delay 5 http://localhost:8000 > /dev/null; then
            echo "→ Приложение успешно запущено!"
          else
            echo "[!] Ошибка: приложение не отвечает"
            docker-compose logs web || true
            exit 1
          fi

          echo "=== Деплой успешно завершен! ==="
