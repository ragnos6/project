name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Upload project to VPS
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "."
        target: "~/project"
        strip_components: 1

    - name: Deploy over SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -e
          echo "[*] Проверка и обновление Docker..."
          # Добавлен флаг -E для сохранения переменных окружения
          sudo -E apt update -y
          sudo -E apt install -y ca-certificates curl gnupg lsb-release
          
          # Установка Docker (если не установлен)
          if ! command -v docker &> /dev/null; then
            echo "[*] Установка Docker..."
            sudo mkdir -p /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
            sudo -E apt update -y
            sudo -E apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
            sudo usermod -aG docker $USER
            echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/docker" | sudo tee /etc/sudoers.d/docker
          fi
          
          # Обновление Docker Compose
          echo "[*] Обновление Docker Compose..."
          sudo -E apt install --only-upgrade docker-compose-plugin -y
          
          cd ~/project
          echo "[*] Проверка и восстановление тома БД..."
          if [ ! "$(sudo docker volume ls -q -f name=project_db)" ]; then
            if [ -f "project_db.tar.gz" ]; then
              echo "→ Восстановление тома project_db из архива"
              sudo docker volume create project_db
              sudo docker run --rm \
                -v project_db:/volume \
                -v $(pwd):/backup \
                alpine \
                sh -c "cd /volume && tar xzf /backup/project_db.tar.gz --strip-components=1"
            else
              echo "→ Архив project_db.tar.gz не найден. Создан пустой volume."
              sudo docker volume create project_db
            fi
          else
            echo "→ Том project_db уже существует. Пропускаем восстановление."
          fi
          
          echo "[*] Перезапуск контейнеров..."
          # Убраны устаревшие флаги
          sudo docker compose down || true
          sudo docker compose up -d --build
          
          echo "[*] Ожидание запуска базы данных (60 сек)..."
          sleep 60  # Увеличено время ожидания
          
          echo "[*] Применение миграций..."
          # Добавлена проверка успешности выполнения команд
          sudo docker compose exec project_cars python manage.py makemigrations
          sudo docker compose exec project_cars python manage.py migrate
          
          echo "[*] Сбор статики..."
          sudo docker compose exec project_cars python manage.py collectstatic --noinput
          echo "[*] Деплой успешно завершен!"
